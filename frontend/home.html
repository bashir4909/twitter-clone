<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Homepage</title>
</head>
<form action="/api/v1/login" method="post" id="login-form" hidden>
  <label for="username">Enter your username here</label>
  <input type="text" name="username" id="username">
  <input type="submit" name="login" value="Login">
</form>
<div id="timeline">
  <dl></dl>
</div>
<form action="/api/v1/logout" method="POST">
  <input type="submit" name="logout" value="Logout">
</form>

<body>
  <script>
    function readCookies() {
      let cookies = {}
      document.cookie.split(";").forEach((pair) => {
        let kv = pair.split("=")
        cookies[kv[0]] = kv[1]
      })
      return cookies
    }

    function appendTw(twUsername, twContent) {
      let dt = document.createElement("dt")
      let a = document.createElement("a")
      a.setAttribute("href", `/userpage.html?username=${twUsername}`)
      a.innerText = "@" + twUsername
      dt.appendChild(a)
      twList.appendChild(dt)
      let dd = document.createElement("dd")
      dd.innerText = twContent
      twList.appendChild(dd)
    }

    function populateTweets() {
      fetch(`http://localhost:3000/api/v1/timeline`)
        .then(rows => rows.json())
        .then(rows => {
          rows.forEach((row) => {
            appendTw(row.username, row.content)
          })
        })
    }
    let userid = readCookies()["userid"]
    let loginform = document.querySelector("#login-form")
    let timeline = document.querySelector("#timeline")
    let twList = document.querySelector("#timeline > dl")
    if (userid) {
      loginform.setAttribute("hidden", "")
      timeline.removeAttribute("hidden")
      populateTweets()
    } else {
      loginform.removeAttribute("hidden")
      timeline.setAttribute("hidden", "")

    }
  </script>
</body>

</html>